# VIDOCQ - Docker Compose Configuration
# Start all services: docker-compose up -d

version: '3.8'

services:
  # ===========================================
  # VIDOCQ API (FastAPI)
  # ===========================================
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: vidocq-api
    ports:
      - "8000:8000"
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-vidocq_secure_2024}
      - REDIS_URL=redis://redis:6379/0
      - QDRANT_URL=http://qdrant:6333
      - ENABLE_PREMIUM_SOURCES=${ENABLE_PREMIUM_SOURCES:-false}
    depends_on:
      - neo4j
      - redis
      - qdrant
    volumes:
      - ./reports:/app/reports
      - ./frontend:/app/frontend
    networks:
      - vidocq-network
    restart: unless-stopped
    command: uvicorn src.api.main:app --host 0.0.0.0 --port 8000

  # ===========================================
  # CELERY WORKER (Background Tasks)
  # ===========================================
  worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: vidocq-worker
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-vidocq_secure_2024}
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/1
      - QDRANT_URL=http://qdrant:6333
    depends_on:
      - neo4j
      - redis
    networks:
      - vidocq-network
    restart: unless-stopped
    command: celery -A src.ingestion.tasks worker -Q celery,parse_queue --loglevel=info -P solo

  # ===========================================
  # NEO4J (Knowledge Graph Database)
  # ===========================================
  neo4j:
    image: neo4j:5-community
    container_name: vidocq-neo4j
    ports:
      - "7474:7474" # HTTP Browser
      - "7687:7687" # Bolt
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD:-vidocq_secure_2024}
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=1G
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    networks:
      - vidocq-network
    restart: unless-stopped

  # ===========================================
  # REDIS (Message Broker + Cache)
  # ===========================================
  redis:
    image: redis:7-alpine
    container_name: vidocq-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - vidocq-network
    restart: unless-stopped
    command: redis-server --appendonly yes

  # ===========================================
  # QDRANT (Vector Database)
  # ===========================================
  qdrant:
    image: qdrant/qdrant:latest
    container_name: vidocq-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - vidocq-network
    restart: unless-stopped

# ===========================================
# VOLUMES
# ===========================================
volumes:
  neo4j_data:
  neo4j_logs:
  redis_data:
  qdrant_data:

    # ===========================================
    # NETWORK
    # ===========================================
networks:
  vidocq-network:
    driver: bridge
